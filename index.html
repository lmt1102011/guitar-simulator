<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guitar Simulator Pro Max - High Quality Audio</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --panel-color: #1a1a1a;
            --accent-color: #f39c12;
            --active-chord: #27ae60;
            --text-color: #ecf0f1;
            --wood-pattern: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        /* --- C·∫¢NH B√ÅO XOAY & FULLSCREEN --- */
        #orientation-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        #orientation-overlay h2 { color: var(--accent-color); margin-bottom: 10px; }
        #orientation-overlay p { margin-bottom: 25px; color: #ccc; }

        .btn-fullscreen {
            padding: 15px 30px;
            background: var(--accent-color);
            border: none;
            border-radius: 50px;
            color: black;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
        }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #121212;
            z-index: 5000;
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .setup-column {
            background: #222;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        .instr-col { flex: 0.8; }
        .chord-col { flex: 3; overflow: hidden; }

        h2 {
            color: var(--accent-color);
            font-size: 1.2rem;
            margin: 0 0 15px 0;
            text-align: center;
            text-transform: uppercase;
        }

        .instr-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chord-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .chord-group {
            margin-bottom: 25px;
        }

        .chord-group h3 {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-color);
            padding-left: 10px;
            text-transform: uppercase;
        }

        .chord-selection-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .selectable {
            padding: 10px 2px;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .selectable.selected {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: #000;
            box-shadow: 0 0 12px rgba(243, 156, 18, 0.4);
        }

        #btn-play {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(to right, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- PLAY SCREEN --- */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        #strum-area {
            flex: 1.5;
            position: relative;
            background-color: #3d2218;
            background-image: var(--wood-pattern);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            overflow: hidden;
            box-shadow: inset -20px 0 60px rgba(0,0,0,0.7);
        }

        #sound-hole-container {
            position: absolute;
            top: 50%;
            left: -18vh;
            transform: translateY(-50%);
            width: 90vh;
            height: 90vh;
            border-radius: 50%;
            background: #000;
            border: 18px solid #2d1b14;
            box-shadow: 
                inset 0 0 80px #000,
                0 0 0 6px #5d4037,
                0 0 30px rgba(0,0,0,0.9);
            z-index: 1;
        }

        #controls-panel {
            flex: 0.6;
            background: var(--panel-color);
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-left: 4px solid #000;
            z-index: 10;
        }

        .chord-active-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            overflow-y: auto;
        }

        .btn-chord {
            padding: 20px 5px;
            background: #252525;
            border: 2px solid #333;
            color: #777;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-chord.active {
            background: var(--active-chord);
            color: #fff;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.4);
            transform: scale(1.05);
        }

        .string-container {
            position: relative;
            width: 100%;
            height: 12%;
            z-index: 5;
            display: flex;
            align-items: center;
        }

        .string {
            width: 100%;
            background: linear-gradient(to bottom, #888, #eee 40%, #fff 50%, #eee 60%, #888);
            box-shadow: 0 3px 5px rgba(0,0,0,0.6);
            pointer-events: none;
        }

        .string[data-index="5"] { height: 6px; } 
        .string[data-index="4"] { height: 5px; }
        .string[data-index="3"] { height: 4px; }
        .string[data-index="2"] { height: 2.8px; }
        .string[data-index="1"] { height: 2px; }
        .string[data-index="0"] { height: 1.4px; }

        @keyframes vibrate {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(2px); }
        }
        .vibrating { animation: vibrate 0.07s infinite; }

        .string-highlight {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.25);
            opacity: 0; pointer-events: none;
        }
        .string-highlight.active { opacity: 1; }

        .btn-reset {
            background: #c0392b;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="orientation-overlay">
        <h2>üé∏ Tr·∫£i Nghi·ªám T·ªët Nh·∫•t</h2>
        <p>Vui l√≤ng xoay ngang m√†n h√¨nh v√† b·∫≠t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh ƒë·ªÉ √¢m thanh kh√¥ng b·ªã r√®.</p>
        <button class="btn-fullscreen" onclick="requestFullScreenAndLandscape()">B·∫ÆT ƒê·∫¶U NGAY</button>
    </div>

    <div id="setup-screen">
        <div class="setup-column instr-col">
            <h2>Lo·∫°i ƒê√†n</h2>
            <div class="instr-list">
                <div class="selectable instr-opt selected" data-val="acoustic">Acoustic</div>
                <div class="selectable instr-opt" data-val="classic">Classic</div>
                <div class="selectable instr-opt" data-val="electric">Electric</div>
            </div>
            <button id="btn-play">CH∆†I</button>
        </div>
        
        <div class="setup-column chord-col">
            <h2>H·ª£p √Çm Bi·∫øn Th·ªÉ</h2>
            <div class="chord-scroll-area">
                <div class="chord-group">
                    <h3>Tr∆∞·ªüng & Th·ª© (Major / Minor)</h3>
                    <div class="chord-selection-grid" id="grid-main"></div>
                </div>
                <div class="chord-group">
                    <h3>H·ª£p √¢m 7 (Dominant / Major 7)</h3>
                    <div class="chord-selection-grid" id="grid-7th"></div>
                </div>
                <div class="chord-group">
                    <h3>Treo (sus2 / sus4)</h3>
                    <div class="chord-selection-grid" id="grid-sus"></div>
                </div>
                <div class="chord-group">
                    <h3>Bi·∫øn th·ªÉ kh√°c (m7 / dim / add9)</h3>
                    <div class="chord-selection-grid" id="grid-ext"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="strum-area">
            <div id="sound-hole-container"></div>
            <div class="string-container" data-string="5"><div class="string-highlight"></div><div class="string" data-index="5"></div></div>
            <div class="string-container" data-string="4"><div class="string-highlight"></div><div class="string" data-index="4"></div></div>
            <div class="string-container" data-string="3"><div class="string-highlight"></div><div class="string" data-index="3"></div></div>
            <div class="string-container" data-string="2"><div class="string-highlight"></div><div class="string" data-index="2"></div></div>
            <div class="string-container" data-string="1"><div class="string-highlight"></div><div class="string" data-index="1"></div></div>
            <div class="string-container" data-string="0"><div class="string-highlight"></div><div class="string" data-index="0"></div></div>
        </div>

        <div id="controls-panel">
            <button class="btn-reset" onclick="location.reload()">‚Üê Quay l·∫°i</button>
            <div class="chord-active-list" id="play-chord-grid"></div>
        </div>
    </div>

    <script>
        const ALL_CHORDS = {
            'C': [0,1,0,2,3,0], 'Cm': [3,4,5,5,3,3], 'D': [2,3,2,0,0,2], 'Dm': [1,3,2,0,0,1],
            'E': [0,0,1,2,2,0], 'Em': [0,0,0,2,2,0], 'F': [1,1,2,3,3,1], 'Fm': [1,1,1,3,3,1],
            'G': [3,0,0,0,2,3], 'Gm': [3,3,3,5,5,3], 'A': [0,2,2,2,0,0], 'Am': [0,1,2,2,0,0],
            'B': [2,4,4,4,2,2], 'Bm': [2,3,4,4,2,2],
            'C7': [0,1,3,2,3,0], 'CMaj7': [0,0,0,2,3,null], 'D7': [2,1,2,0,0,2], 'E7': [0,3,1,2,2,0],
            'G7': [1,0,0,0,2,3], 'A7': [0,2,0,2,0,0], 'B7': [2,0,2,1,2,2], 'AMaj7': [0,2,1,2,0,0],
            'Csus4': [null,1,0,3,3,null], 'Dsus2': [0,3,2,0,0,null], 'Dsus4': [3,3,2,0,0,null],
            'Esus4': [0,0,2,2,2,0], 'Asus2': [0,0,2,2,0,0], 'Asus4': [0,3,2,2,0,0], 'Gsus4': [3,1,0,0,2,3],
            'Am7': [0,1,0,2,0,0], 'Dm7': [1,1,2,0,0,null], 'Em7': [0,3,0,2,2,0], 'Cadd9': [0,3,0,2,3,null],
            'Dadd9': [0,3,2,4,5,null], 'Fdim': [1,0,1,0,null,null], 'Gdim': [3,2,3,2,null,null]
        };

        const GROUPS = {
            'grid-main': ['C','Cm','D','Dm','E','Em','F','Fm','G','Gm','A','Am','B','Bm'],
            'grid-7th': ['C7','CMaj7','D7','E7','G7','A7','B7','AMaj7'],
            'grid-sus': ['Csus4','Dsus2','Dsus4','Esus4','Asus2','Asus4','Gsus4'],
            'grid-ext': ['Am7','Dm7','Em7','Cadd9','Dadd9','Fdim','Gdim']
        };

        const BASE_FREQS = [329.63, 246.94, 196.00, 146.83, 110.00, 82.41]; 
        let audioCtx = null;
        let masterGain = null;
        let masterCompressor = null;
        let instrument = 'acoustic';
        let myChords = [];
        let activeChord = '';

        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            const overlay = document.getElementById('orientation-overlay');
            if (isPortrait) {
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        async function requestFullScreenAndLandscape() {
            const docEl = document.documentElement;
            try {
                if (docEl.requestFullscreen) await docEl.requestFullscreen();
                else if (docEl.webkitRequestFullscreen) await docEl.webkitRequestFullscreen();
            } catch (err) {}
            try {
                if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape');
            } catch (err) {}
            checkOrientation();
            initAudio();
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master Limiter/Compressor to prevent clipping (r√®)
                masterCompressor = audioCtx.createDynamicsCompressor();
                masterCompressor.threshold.setValueAtTime(-10, audioCtx.currentTime);
                masterCompressor.knee.setValueAtTime(40, audioCtx.currentTime);
                masterCompressor.ratio.setValueAtTime(12, audioCtx.currentTime);
                masterCompressor.attack.setValueAtTime(0, audioCtx.currentTime);
                masterCompressor.release.setValueAtTime(0.25, audioCtx.currentTime);

                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.8; // Gi·∫£m t·ªïng √¢m l∆∞·ª£ng m·ªôt ch√∫t ƒë·ªÉ tr√°nh r√®

                masterCompressor.connect(masterGain);
                masterGain.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        window.addEventListener('resize', checkOrientation);
        window.addEventListener('load', checkOrientation);

        function init() {
            for (let gridId in GROUPS) {
                const grid = document.getElementById(gridId);
                GROUPS[gridId].forEach(chord => {
                    const el = document.createElement('div');
                    el.className = `selectable ${myChords.includes(chord) ? 'selected' : ''}`;
                    el.textContent = chord;
                    el.onclick = () => {
                        if (myChords.includes(chord)) {
                            myChords = myChords.filter(c => c !== chord);
                            el.classList.remove('selected');
                        } else {
                            myChords.push(chord);
                            el.classList.add('selected');
                        }
                    };
                    grid.appendChild(el);
                });
            }

            document.querySelectorAll('.instr-opt').forEach(opt => {
                opt.onclick = () => {
                    document.querySelectorAll('.instr-opt').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    instrument = opt.dataset.val;
                };
            });
        }

        document.getElementById('btn-play').onclick = () => {
            if (myChords.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ª£p √¢m!");
            activeChord = myChords[0];
            initAudio();
            
            const playGrid = document.getElementById('play-chord-grid');
            playGrid.innerHTML = '';
            myChords.forEach(chord => {
                const btn = document.createElement('div');
                btn.className = `btn-chord ${chord === activeChord ? 'active' : ''}`;
                btn.textContent = chord;
                btn.onclick = () => {
                    activeChord = chord;
                    document.querySelectorAll('.btn-chord').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                playGrid.appendChild(btn);
            });

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-container').style.opacity = '1';
        };

        function playString(idx) {
            if (!audioCtx || !activeChord) return;
            const t = audioCtx.currentTime;
            const semitones = ALL_CHORDS[activeChord][idx];
            if (semitones === null) return; // D√¢y kh√¥ng b·∫•m

            const freq = BASE_FREQS[idx] * Math.pow(2, semitones / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            // Setup Filter (Lo·∫°i b·ªè t·∫ßn s·ªë g√¢y r√®)
            filter.type = "lowpass";
            filter.frequency.setValueAtTime(instrument === 'electric' ? 2500 : 4000, t);
            filter.Q.setValueAtTime(1, t);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(masterCompressor);

            osc.frequency.setValueAtTime(freq, t);
            
            if (instrument === 'acoustic') {
                osc.type = 'triangle';
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.5, t + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 2.0);
            } else if (instrument === 'classic') {
                osc.type = 'sine';
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.4, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
            } else {
                // Electric: D√πng h·ªón h·ª£p s√≥ng ƒë·ªÉ t·∫°o ti·∫øng d√†y nh∆∞ng filter k·ªπ
                osc.type = 'sawtooth';
                filter.frequency.exponentialRampToValueAtTime(800, t + 1.0);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.3, t + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 3.0);
            }
            
            osc.start(t);
            osc.stop(t + 3);
        }

        function trigger(container, idx) {
            const str = container.querySelector('.string');
            str.classList.remove('vibrating');
            void str.offsetWidth;
            str.classList.add('vibrating');
            setTimeout(() => str.classList.remove('vibrating'), 800);
            container.querySelector('.string-highlight').classList.add('active');
            setTimeout(() => container.querySelector('.string-highlight').classList.remove('active'), 200);
            playString(parseInt(idx));
        }

        const area = document.getElementById('strum-area');
        let lastId = null;
        const handleMove = (e) => {
            const touch = e.touches ? e.touches[0] : e;
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            const container = el?.closest('.string-container');
            if (container) {
                const id = container.dataset.string;
                if (id !== lastId) { trigger(container, id); lastId = id; }
            } else { lastId = null; }
        };

        area.onmousedown = (e) => { area.onmousemove = handleMove; handleMove(e); };
        window.onmouseup = () => area.onmousemove = null;
        area.ontouchstart = (e) => handleMove(e);
        area.ontouchmove = (e) => { e.preventDefault(); handleMove(e); };
        area.ontouchend = () => lastId = null;

        init();
    </script>
</body>
</html>